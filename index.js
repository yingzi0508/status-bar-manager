const e='状态栏管理',t='th-status-bar-extension-entry',n='status_bar_manager_script',a='[状态栏] ';function i(){return SillyTavern.extensionSettings[n]||(SillyTavern.extensionSettings[n]={bindings:[]}),SillyTavern.extensionSettings[n]}async function o(e){i().bindings=e.bindings,await SillyTavern.saveSettingsDebounced()}function r(e){return e.startsWith(a)?e:`${a}${e}`}function l(){return getTavernRegexes().filter(e=>e.script_name.startsWith(a))}function s(e){return getTavernRegexes().find(t=>t.id===e)}async function d(e){const t=e.find('input[data-role="regexFile"]')[0];if(!t?.files?.length)return;const n=t.files[0];let a='';try{a=await n.text()}catch{return void toastr.error('读取文件失败')}const i=new Set(getTavernRegexes().map(e=>e.id));let o=[];try{const e=JSON.parse(a),t=(s=e,Array.isArray(s)?s:Array.isArray(s?.regex_scripts)?s.regex_scripts:Array.isArray(s?.data?.regex_scripts)?s.data.regex_scripts:s&&'object'==typeof s?[s]:[]);o=t.map(e=>function(e){return String(e.script_name??e.scriptName??e.name??e.title??'').trim()}(e)).filter(e=>e.length>0)}catch{o=[]}var s;if(!importRawTavernRegex(n.name,a))return void toastr.error('导入失败，请确认使用酒馆原生正则导出文件');await updateTavernRegexesWith(e=>{let t=0;return e.map(e=>{if(!!i.has(e.id))return e;const n=o[t]??e.script_name;return t+=1,{...e,script_name:r(n)}})});const d=l().length;toastr.success(`已导入，当前可管理状态栏正则 ${d} 条`)}async function c(e){let t=null,n=null;try{const n=(await getWorldbook(e.worldbook_name)).find(t=>t.uid===e.worldbook_entry_uid);n&&(t=n.enabled)}catch{}const a=s(e.regex_id);return a&&(n=a.enabled),{worldbook_enabled:t,regex_enabled:n}}function p(e,t){const n=e.find('[data-role="tab-binding"]'),a=e.find('[data-role="tab-style"]');'binding'===t?(n.show(),a.hide()):(n.hide(),a.show())}async function u(e){const t=getWorldbookNames(),n=e=>{if(e.empty(),0!==t.length)for(const n of t)e.append(`<option value="${n}">${n}</option>`);else e.append('<option value="">（无世界书）</option>')};n(e.find('select[data-role="worldbook"]')),e.find('select[data-role="worldbook-extra"]').each(function(){n($(this))})}async function f(e){const t=async(e,t)=>{if(e.empty(),!t)return void e.append('<option value="">（先选择世界书）</option>');const n=await getWorldbook(t);if(0!==n.length)for(const t of n){const n=t.name||`未命名条目-${t.uid}`;e.append(`<option value="${t.uid}">${n} (uid=${t.uid})</option>`)}else e.append('<option value="">（该世界书无条目）</option>')},n=String(e.find('select[data-role="worldbook"]').val()??'');await t(e.find('select[data-role="entry"]'),n);const a=e.find('select[data-role="worldbook-extra"]');for(let e=0;e<a.length;e+=1){const n=$(a[e]),i=n.closest('[data-worldbook-row-id]'),o=String(n.val()??''),r=i.find('select[data-role="entry-extra"]');await t(r,o)}}function b(e){const t=l(),n=e=>{if(e.empty(),0!==t.length)for(const n of t)e.append(`<option value="${n.id}">${n.script_name}</option>`);else e.append('<option value="">（暂无状态栏正则，请先导入）</option>')};n(e.find('select[data-role="regex"]')),e.find('select[data-role="regex-extra"]').each(function(){n($(this))})}async function g(e){const t=s(e.regex_id);if(!t)return void toastr.error('未找到对应正则');const n=function(e){const t=e.trim(),n=t.match(/^```[a-zA-Z0-9_-]*\n([\s\S]*?)\n```$/);return n?n[1].trim():t}(String(t.replace_string??''));var a,i;0!==n.length?await(a=e.label,i=function(e){const t=e.trim();return/<html[\s>]/i.test(t)||/<!doctype\s+html/i.test(t)?t:`<!doctype html>\n<html lang="zh-CN">\n  <head>\n    <meta charset="UTF-8" />\n    <meta name="viewport" content="width=device-width, initial-scale=1.0" />\n  </head>\n  <body>\n    ${t}\n  </body>\n</html>`}(n),new Promise(e=>{const t=$(`\n      <div\n        data-role="statusbar-preview-overlay"\n        style="position:fixed; inset:0; z-index:2147483000; background:rgba(0,0,0,.55); display:flex; flex-direction:column;"\n      >\n        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; background:rgba(0,0,0,.75); color:#fff;">\n          <div style="font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">预览：${a}</div>\n          <button type="button" data-role="closePreview" style="padding:6px 12px; border:none; border-radius:6px; cursor:pointer;">关闭</button>\n        </div>\n        <iframe\n          data-role="previewFrameFullscreen"\n          sandbox="allow-scripts allow-modals allow-popups"\n          style="flex:1; width:100%; border:none; background:#fff;"\n        ></iframe>\n      </div>\n    `),n=t.find('iframe[data-role="previewFrameFullscreen"]')[0];n&&(n.srcdoc=i);const o=()=>{$(document).off('keydown',r),t.remove(),e()},r=e=>{'Escape'===e.key&&o()};t.on('click','[data-role="closePreview"]',()=>{o()}),t.on('click',e=>{e.target===t[0]&&o()}),$(document).on('keydown',r),$('body').append(t)})):toastr.info('该正则 replace_string 为空，暂无可预览内容。')}function y(e){e.setAttribute('data-th-statusbar-manager-fullscreen','1'),e.style.position='fixed',e.style.inset='0',e.style.margin='0',e.style.padding='0',e.style.width='100vw',e.style.maxWidth='100vw',e.style.height='100vh',e.style.maxHeight='100vh',e.style.borderRadius='0';const t=e.querySelector('.popup')??e.firstElementChild??null;t&&(t.style.position='fixed',t.style.inset='0',t.style.margin='0',t.style.width='100vw',t.style.maxWidth='100vw',t.style.height='100vh',t.style.maxHeight='100vh',t.style.borderRadius='0',t.style.display='flex',t.style.flexDirection='column');const n=e.querySelector('.popup-content')??e.querySelector('.popup-body')??e.querySelector('.popup_text')??null;n&&(n.style.flex='1',n.style.minHeight='0',n.style.overflow='hidden')}async function w(e,t){await u(e),await f(e),b(e),await async function(e,t){const n=e.find('[data-role="styleList"]');if(n.empty(),0!==t.bindings.length)for(const e of t.bindings){const t=await c(e),a=!0===t.worldbook_enabled&&!0===t.regex_enabled,i=$(`<div style="padding:10px 0; border-bottom:1px solid rgba(127,127,127,.35);">\n        <div style="font-weight:600; margin-bottom:6px;">${e.label}</div>\n        <div>世界书名：${e.worldbook_name}</div>\n        <div>条目名：${e.worldbook_entry_name} (uid=${e.worldbook_entry_uid})</div>\n        <div>正则名：${e.regex_script_name}</div>\n        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; align-items:center;">\n          <span role="button" tabindex="0" data-action="toggleBinding" data-id="${e.id}"><i class="fa-solid fa-power-off"></i> ${a?'关闭':'开启'}</span>\n          <span role="button" tabindex="0" data-action="renameStyle" data-id="${e.id}"><i class="fa-solid fa-pen"></i> 改名</span>\n          <span role="button" tabindex="0" data-action="previewStyle" data-id="${e.id}"><i class="fa-solid fa-eye"></i> 预览</span>\n          <span role="button" tabindex="0" data-action="deleteBinding" data-id="${e.id}"><i class="fa-solid fa-trash"></i> 删除</span>\n        </div>\n      </div>`);n.append(i)}else n.append('<div>暂无样式</div>')}(e,t)}async function v(){const e=function(){const e=i();return Array.isArray(e.bindings)||(e.bindings=[]),{bindings:e.bindings}}(),t=$('\n    <style>\n      .th-statusbar-manager-shell {\n        height: 100%;\n        overflow: auto;\n        -webkit-overflow-scrolling: touch;\n        scrollbar-width: none;\n        -ms-overflow-style: none;\n        padding: 12px;\n        box-sizing: border-box;\n      }\n      .th-statusbar-manager-shell::-webkit-scrollbar {\n        width: 0;\n        height: 0;\n        display: none;\n      }\n    </style>\n    <div class="th-statusbar-manager-shell">\n      <h3><i class="fa-solid fa-puzzle-piece"></i> 状态栏管理器</h3>\n\n      <div style="display:flex; gap:14px; align-items:center; flex-wrap:wrap; margin:8px 0 12px;">\n        <span role="button" tabindex="0" data-action="switchTab" data-tab="binding"><i class="fa-solid fa-link"></i> 绑定状态栏</span>\n        <span role="button" tabindex="0" data-action="switchTab" data-tab="style"><i class="fa-solid fa-list"></i> 状态栏样式列表</span>\n      </div>\n\n      <div data-role="tab-binding">\n        <h4>绑定状态栏</h4>\n        <div>\n          <label>世界书：</label>\n          <select data-role="worldbook"></select>\n        </div>\n        <div>\n          <label>世界书条目：</label>\n          <select data-role="entry"></select>\n        </div>\n        <div>\n          <span role="button" tabindex="0" data-action="addWorldbookRow"><i class="fa-solid fa-plus"></i> 增加世界书条目</span>\n        </div>\n        <div data-role="extraWorldbookRows"></div>\n        <div style="margin-top:8px;">\n          <label>状态栏正则：</label>\n          <select data-role="regex"></select>\n        </div>\n        <div>\n          <span role="button" tabindex="0" data-action="addRegexRow"><i class="fa-solid fa-plus"></i> 增加正则</span>\n        </div>\n        <div data-role="extraRegexRows"></div>\n        <div style="display:flex; gap:14px; align-items:center; flex-wrap:wrap; margin-top:8px;">\n          <span role="button" tabindex="0" data-action="pickRegexFile"><i class="fa-solid fa-file-import"></i> 导入正则文件</span>\n          <span role="button" tabindex="0" data-action="createBinding"><i class="fa-solid fa-plus"></i> 创建绑定</span>\n          <span role="button" tabindex="0" data-action="refresh"><i class="fa-solid fa-rotate"></i> 刷新</span>\n        </div>\n        <input type="file" data-role="regexFile" accept=".json,application/json" style="display:none;" />\n\n      </div>\n\n      <div data-role="tab-style" style="display:none;">\n        <h4>状态栏样式列表</h4>\n        <div data-role="styleList"></div>\n      </div>\n    </div>\n  ');t.on('change','select[data-role="worldbook"]',async()=>{await f(t)}),t.on('change','select[data-role="worldbook-extra"]',async()=>{await f(t)}),t.on('click','[data-action="switchTab"]',function(){const e=String($(this).data('tab')??'binding');p(t,'style'===e?'style':'binding')}),t.on('click','[data-action="pickRegexFile"]',()=>{const e=t.find('input[data-role="regexFile"]');e.val(''),e.trigger('click')}),t.on('change','input[data-role="regexFile"]',async()=>{await d(t),await w(t,e)}),t.on('click','[data-action="addWorldbookRow"]',async()=>{t.find('[data-role="extraWorldbookRows"]').append($(`<div data-worldbook-row-id="${SillyTavern.uuidv4()}" style="margin-top:8px;">\n      <div>\n        <label>世界书：</label>\n        <select data-role="worldbook-extra"></select>\n      </div>\n      <div>\n        <label>世界书条目：</label>\n        <select data-role="entry-extra"></select>\n      </div>\n      <div>\n        <span role="button" tabindex="0" data-action="removeWorldbookRow"><i class="fa-solid fa-trash"></i> 删除此世界书条目</span>\n      </div>\n    </div>`)),await u(t),await f(t)}),t.on('click','[data-action="removeWorldbookRow"]',async function(){$(this).closest('[data-worldbook-row-id]').remove()}),t.on('click','[data-action="addRegexRow"]',async()=>{t.find('[data-role="extraRegexRows"]').append($(`<div data-regex-row-id="${SillyTavern.uuidv4()}" style="margin-top:8px;">\n      <div>\n        <label>状态栏正则：</label>\n        <select data-role="regex-extra"></select>\n      </div>\n      <div>\n        <span role="button" tabindex="0" data-action="removeRegexRow"><i class="fa-solid fa-trash"></i> 删除此正则</span>\n      </div>\n    </div>`)),b(t)}),t.on('click','[data-action="removeRegexRow"]',async function(){$(this).closest('[data-regex-row-id]').remove()}),t.on('click','[data-action="createBinding"]',async()=>{await async function(e,t){const n=[],a=[],i=String(e.find('select[data-role="worldbook"]').val()??''),r=Number(e.find('select[data-role="entry"]').val()??NaN);n.push({worldbookName:i,entryUid:r}),e.find('[data-worldbook-row-id]').each(function(){const e=$(this),t=String(e.find('select[data-role="worldbook-extra"]').val()??''),a=Number(e.find('select[data-role="entry-extra"]').val()??NaN);n.push({worldbookName:t,entryUid:a})});const s=String(e.find('select[data-role="regex"]').val()??'');a.push(s),e.find('[data-regex-row-id]').each(function(){const e=$(this),t=String(e.find('select[data-role="regex-extra"]').val()??'');a.push(t)});const d=n.filter(e=>e.worldbookName&&Number.isInteger(e.entryUid)),c=a.filter(e=>e.length>0);if(0===d.length||0===c.length)return void toastr.warning('请至少完整选择一条世界书条目，并至少选择一条正则');const p=l();let u=0;for(const e of d){const n=(await getWorldbook(e.worldbookName)).find(t=>t.uid===e.entryUid);if(n)for(const a of c){const i=p.find(e=>e.id===a);i&&(t.bindings.find(t=>t.worldbook_name===e.worldbookName&&t.worldbook_entry_uid===e.entryUid&&t.regex_id===a)||(t.bindings.push({id:SillyTavern.uuidv4(),label:`${e.worldbookName} / ${n.name||n.uid}`,worldbook_name:e.worldbookName,worldbook_entry_uid:n.uid,worldbook_entry_name:n.name||`未命名条目-${n.uid}`,regex_id:i.id,regex_script_name:i.script_name}),u+=1))}}0!==u?(await o(t),toastr.success(`已创建 ${u} 条绑定`)):toastr.info('没有新增绑定（可能已存在或选择无效）')}(t,e),await w(t,e)}),t.on('click','[data-action="toggleBinding"]',async function(){const n=String($(this).data('id')??''),a=e.bindings.find(e=>e.id===n);if(!a)return;const i=await c(a),o=!(!0===i.worldbook_enabled&&!0===i.regex_enabled);try{await async function(e,t){let n=!1,a=!1;if(await updateWorldbookWith(e.worldbook_name,a=>a.map(a=>a.uid===e.worldbook_entry_uid?(n=!0,{...a,enabled:t}):a)),await updateTavernRegexesWith(n=>n.map(n=>n.id===e.regex_id?(a=!0,{...n,enabled:t,script_name:r(n.script_name)}):n)),!n&&!a)throw new Error('未找到可切换的世界书条目或正则')}(a,o),toastr.success(`${a.label} 已${o?'开启':'关闭'}`)}catch(e){console.error(e),toastr.error('同步开关失败')}await w(t,e)}),t.on('click','[data-action="deleteBinding"]',async function(){const n=String($(this).data('id')??'');e.bindings=e.bindings.filter(e=>e.id!==n),await o(e),await w(t,e),toastr.success('绑定已删除')}),t.on('click','[data-action="renameStyle"]',async function(){const n=String($(this).data('id')??''),a=e.bindings.find(e=>e.id===n);if(!a)return;const i=await async function(e,t=''){const n=await SillyTavern.callGenericPopup(e,SillyTavern.POPUP_TYPE.INPUT,t,{okButton:'确认',cancelButton:'取消',rows:3,wider:!0});return!1===n||null==n?null:String(n).trim()}('输入新的显示名',a.label);i&&(a.label=i,await o(e),await w(t,e),toastr.success('名称已更新'))}),t.on('click','[data-action="previewStyle"]',async function(){const t=String($(this).data('id')??''),n=e.bindings.find(e=>e.id===t);n&&await g(n)}),t.on('click','[data-action="refresh"]',async()=>{await w(t,e),toastr.info('已刷新')}),t.on('keydown','[role="button"][data-action]',function(e){'Enter'!==e.key&&' '!==e.key||(e.preventDefault(),$(this).trigger('click'))}),t.on('touchend','[role="button"][data-action]',function(e){e.preventDefault(),e.stopPropagation(),$(this).trigger('click')}),await w(t,e),p(t,'style'),await async function(e){await SillyTavern.callGenericPopup(e,SillyTavern.POPUP_TYPE.DISPLAY,'',{okButton:'关闭',leftAlign:!0,wide:!0,wider:!0,large:!0,allowVerticalScrolling:!1,onOpen:async e=>{const t=e.dlg;t&&(y(t),requestAnimationFrame(()=>y(t)))},onClose:async e=>{const t=e.dlg;t&&t.removeAttribute('data-th-statusbar-manager-fullscreen')}})}(t)}function x(){if($(`#${t}`).length>0)return;const n=function(){const e=['#extensionsMenu','#extensions-menu','#extensions_dropdown','#extensions_settings2','.extensionsMenu','.extensions-menu','.drawer-content:has(.fa-solid), .drawer-content:has(.fa-regular)'];for(const t of e){const e=$(t).first();if(e.length>0)return e}return $()}();0!==n.length&&n.append($(`<div id="${t}" role="button" tabindex="0"><i class="fa-solid fa-puzzle-piece"></i> ${e}</div>`).on('click',async()=>{await eventEmit(getButtonEvent(e))}).on('keydown',async t=>{'Enter'!==t.key&&' '!==t.key||(t.preventDefault(),await eventEmit(getButtonEvent(e)))}))}$(()=>{replaceScriptButtons([]),eventOn(getButtonEvent(e),async()=>{try{await v()}catch(e){console.error(e),toastr.error('状态栏管理器打开失败')}}),x(),eventOn(tavern_events.APP_READY,x),eventOn(tavern_events.EXTENSIONS_FIRST_LOAD,x);const n=new MutationObserver(()=>{x()});n.observe(document.body,{childList:!0,subtree:!0}),$(window).on('pagehide',()=>{n.disconnect(),$(`#${t}`).remove()})});