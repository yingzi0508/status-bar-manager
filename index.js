const n='状态栏管理',e='th-status-bar-extension-entry',t='status_bar_manager_script',a='[状态栏] ';function o(){return SillyTavern.extensionSettings[t]||(SillyTavern.extensionSettings[t]={bindings:[]}),SillyTavern.extensionSettings[t]}async function i(n){o().bindings=n.bindings,await SillyTavern.saveSettingsDebounced()}function r(n){return n.startsWith(a)?n:`${a}${n}`}function d(){return getTavernRegexes().filter(n=>n.script_name.startsWith(a))}function l(n){return getTavernRegexes().find(e=>e.id===n)}async function s(n){const e=n.find('input[data-role="regexFile"]')[0];if(!e?.files?.length)return;const t=e.files[0];let a='';try{a=await t.text()}catch{return void toastr.error('读取文件失败')}const o=new Set(getTavernRegexes().map(n=>n.id));let i=[];try{const n=JSON.parse(a),e=(l=n,Array.isArray(l)?l:Array.isArray(l?.regex_scripts)?l.regex_scripts:Array.isArray(l?.data?.regex_scripts)?l.data.regex_scripts:l&&'object'==typeof l?[l]:[]);i=e.map(n=>function(n){return String(n.script_name??n.scriptName??n.name??n.title??'').trim()}(n)).filter(n=>n.length>0)}catch{i=[]}var l;if(!importRawTavernRegex(t.name,a))return void toastr.error('导入失败，请确认使用酒馆原生正则导出文件');await updateTavernRegexesWith(n=>{let e=0;return n.map(n=>{if(!!o.has(n.id))return n;const t=i[e]??n.script_name;return e+=1,{...n,script_name:r(t)}})});const s=d().length;toastr.success(`已导入，当前可管理状态栏正则 ${s} 条`)}async function c(n){let e=null,t=null;try{const t=(await getWorldbook(n.worldbook_name)).find(e=>e.uid===n.worldbook_entry_uid);t&&(e=t.enabled)}catch{}const a=l(n.regex_id);return a&&(t=a.enabled),{worldbook_enabled:e,regex_enabled:t}}function p(n,e){const t=n.find('[data-role="tab-binding"]'),a=n.find('[data-role="tab-style"]');'binding'===e?(t.show(),a.hide()):(t.hide(),a.show())}async function f(n){const e=getWorldbookNames(),t=n=>{if(n.empty(),0!==e.length)for(const t of e)n.append(`<option value="${t}">${t}</option>`);else n.append('<option value="">（无世界书）</option>')};t(n.find('select[data-role="worldbook"]')),n.find('select[data-role="worldbook-extra"]').each(function(){t($(this))})}async function b(n){const e=async(n,e)=>{if(n.empty(),!e)return void n.append('<option value="">（先选择世界书）</option>');const t=await getWorldbook(e);if(0!==t.length)for(const e of t){const t=e.name||`未命名条目-${e.uid}`;n.append(`<option value="${e.uid}">${t} (uid=${e.uid})</option>`)}else n.append('<option value="">（该世界书无条目）</option>')},t=String(n.find('select[data-role="worldbook"]').val()??'');await e(n.find('select[data-role="entry"]'),t);const a=n.find('select[data-role="worldbook-extra"]');for(let n=0;n<a.length;n+=1){const t=$(a[n]),o=t.closest('[data-worldbook-row-id]'),i=String(t.val()??''),r=o.find('select[data-role="entry-extra"]');await e(r,i)}}function u(n){const e=d(),t=n=>{if(n.empty(),0!==e.length)for(const t of e)n.append(`<option value="${t.id}">${t.script_name}</option>`);else n.append('<option value="">（暂无状态栏正则，请先导入）</option>')};t(n.find('select[data-role="regex"]')),n.find('select[data-role="regex-extra"]').each(function(){t($(this))})}async function g(n){const e=l(n.regex_id);if(!e)return void toastr.error('未找到对应正则');const t=function(n){const e=n.trim(),t=e.match(/^```[a-zA-Z0-9_-]*\n([\s\S]*?)\n```$/);return t?t[1].trim():e}(String(e.replace_string??''));var a,o;0!==t.length?await(a=n.label,o=function(n){const e=n.trim();return/<html[\s>]/i.test(e)||/<!doctype\s+html/i.test(e)?e:`<!doctype html>\n<html lang="zh-CN">\n  <head>\n    <meta charset="UTF-8" />\n    <meta name="viewport" content="width=device-width, initial-scale=1.0" />\n  </head>\n  <body>\n    ${e}\n  </body>\n</html>`}(t),new Promise(n=>{const e=$(`\n      <div\n        data-role="statusbar-preview-overlay"\n        style="position:fixed; inset:0; z-index:2147483000; background:rgba(0,0,0,.55); display:flex; flex-direction:column;"\n      >\n        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; background:rgba(0,0,0,.75); color:#fff;">\n          <div style="font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">预览：${a}</div>\n          <button type="button" data-role="closePreview" style="padding:6px 12px; border:none; border-radius:6px; cursor:pointer;">关闭</button>\n        </div>\n        <iframe\n          data-role="previewFrameFullscreen"\n          sandbox="allow-scripts allow-modals allow-popups"\n          style="flex:1; width:100%; border:none; background:#fff;"\n        ></iframe>\n      </div>\n    `),t=e.find('iframe[data-role="previewFrameFullscreen"]')[0];t&&(t.srcdoc=o);const i=()=>{$(document).off('keydown',r),e.remove(),n()},r=n=>{'Escape'===n.key&&i()};e.on('click','[data-role="closePreview"]',()=>{i()}),e.on('click',n=>{n.target===e[0]&&i()}),$(document).on('keydown',r),$('body').append(e)})):toastr.info('该正则 replace_string 为空，暂无可预览内容。')}async function v(n,e){await f(n),await b(n),u(n),await async function(n,e){const t=n.find('[data-role="styleList"]');if(t.empty(),0!==e.bindings.length)for(const n of e.bindings){const e=await c(n),a=!0===e.worldbook_enabled&&!0===e.regex_enabled,o=$(`<div style="padding:10px 0; border-bottom:1px solid rgba(127,127,127,.35);">\n        <div style="font-weight:600; margin-bottom:6px;">${n.label}</div>\n        <div>世界书名：${n.worldbook_name}</div>\n        <div>条目名：${n.worldbook_entry_name} (uid=${n.worldbook_entry_uid})</div>\n        <div>正则名：${n.regex_script_name}</div>\n        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; align-items:center;">\n          <span role="button" tabindex="0" data-action="toggleBinding" data-id="${n.id}"><i class="fa-solid fa-power-off"></i> ${a?'关闭':'开启'}</span>\n          <span role="button" tabindex="0" data-action="renameStyle" data-id="${n.id}"><i class="fa-solid fa-pen"></i> 改名</span>\n          <span role="button" tabindex="0" data-action="previewStyle" data-id="${n.id}"><i class="fa-solid fa-eye"></i> 预览</span>\n          <span role="button" tabindex="0" data-action="deleteBinding" data-id="${n.id}"><i class="fa-solid fa-trash"></i> 删除</span>\n        </div>\n      </div>`);t.append(o)}else t.append('<div>暂无样式</div>')}(n,e)}async function w(){const n=function(){const n=o();return Array.isArray(n.bindings)||(n.bindings=[]),{bindings:n.bindings}}(),e=$('\n    <style>\n      .th-statusbar-manager-shell {\n        height: 100%;\n        overflow: auto;\n        -webkit-overflow-scrolling: touch;\n        scrollbar-width: none;\n        -ms-overflow-style: none;\n        padding: 12px;\n        box-sizing: border-box;\n        background: var(--SmartThemeBlurTintColor, #111);\n        color: var(--SmartThemeBodyColor, #f3f3f3);\n      }\n      .th-statusbar-manager-shell::-webkit-scrollbar {\n        width: 0;\n        height: 0;\n        display: none;\n      }\n    </style>\n    <div class="th-statusbar-manager-shell">\n      <h3><i class="fa-solid fa-puzzle-piece"></i> 状态栏管理器</h3>\n\n      <div style="display:flex; gap:14px; align-items:center; flex-wrap:wrap; margin:8px 0 12px;">\n        <span role="button" tabindex="0" data-action="switchTab" data-tab="binding"><i class="fa-solid fa-link"></i> 绑定状态栏</span>\n        <span role="button" tabindex="0" data-action="switchTab" data-tab="style"><i class="fa-solid fa-list"></i> 状态栏样式列表</span>\n      </div>\n\n      <div data-role="tab-binding">\n        <h4>绑定状态栏</h4>\n        <div>\n          <label>世界书：</label>\n          <select data-role="worldbook"></select>\n        </div>\n        <div>\n          <label>世界书条目：</label>\n          <select data-role="entry"></select>\n        </div>\n        <div>\n          <span role="button" tabindex="0" data-action="addWorldbookRow"><i class="fa-solid fa-plus"></i> 增加世界书条目</span>\n        </div>\n        <div data-role="extraWorldbookRows"></div>\n        <div style="margin-top:8px;">\n          <label>状态栏正则：</label>\n          <select data-role="regex"></select>\n        </div>\n        <div>\n          <span role="button" tabindex="0" data-action="addRegexRow"><i class="fa-solid fa-plus"></i> 增加正则</span>\n        </div>\n        <div data-role="extraRegexRows"></div>\n        <div style="display:flex; gap:14px; align-items:center; flex-wrap:wrap; margin-top:8px;">\n          <span role="button" tabindex="0" data-action="pickRegexFile"><i class="fa-solid fa-file-import"></i> 导入正则文件</span>\n          <span role="button" tabindex="0" data-action="createBinding"><i class="fa-solid fa-plus"></i> 创建绑定</span>\n          <span role="button" tabindex="0" data-action="refresh"><i class="fa-solid fa-rotate"></i> 刷新</span>\n        </div>\n        <input type="file" data-role="regexFile" accept=".json,application/json" style="display:none;" />\n\n      </div>\n\n      <div data-role="tab-style" style="display:none;">\n        <h4>状态栏样式列表</h4>\n        <div data-role="styleList"></div>\n      </div>\n    </div>\n  ');e.on('change','select[data-role="worldbook"]',async()=>{await b(e)}),e.on('change','select[data-role="worldbook-extra"]',async()=>{await b(e)}),e.on('click','[data-action="switchTab"]',function(){const n=String($(this).data('tab')??'binding');p(e,'style'===n?'style':'binding')}),e.on('click','[data-action="pickRegexFile"]',()=>{const n=e.find('input[data-role="regexFile"]');n.val(''),n.trigger('click')}),e.on('change','input[data-role="regexFile"]',async()=>{await s(e),await v(e,n)}),e.on('click','[data-action="addWorldbookRow"]',async()=>{e.find('[data-role="extraWorldbookRows"]').append($(`<div data-worldbook-row-id="${SillyTavern.uuidv4()}" style="margin-top:8px;">\n      <div>\n        <label>世界书：</label>\n        <select data-role="worldbook-extra"></select>\n      </div>\n      <div>\n        <label>世界书条目：</label>\n        <select data-role="entry-extra"></select>\n      </div>\n      <div>\n        <span role="button" tabindex="0" data-action="removeWorldbookRow"><i class="fa-solid fa-trash"></i> 删除此世界书条目</span>\n      </div>\n    </div>`)),await f(e),await b(e)}),e.on('click','[data-action="removeWorldbookRow"]',async function(){$(this).closest('[data-worldbook-row-id]').remove()}),e.on('click','[data-action="addRegexRow"]',async()=>{e.find('[data-role="extraRegexRows"]').append($(`<div data-regex-row-id="${SillyTavern.uuidv4()}" style="margin-top:8px;">\n      <div>\n        <label>状态栏正则：</label>\n        <select data-role="regex-extra"></select>\n      </div>\n      <div>\n        <span role="button" tabindex="0" data-action="removeRegexRow"><i class="fa-solid fa-trash"></i> 删除此正则</span>\n      </div>\n    </div>`)),u(e)}),e.on('click','[data-action="removeRegexRow"]',async function(){$(this).closest('[data-regex-row-id]').remove()}),e.on('click','[data-action="createBinding"]',async()=>{await async function(n,e){const t=[],a=[],o=String(n.find('select[data-role="worldbook"]').val()??''),r=Number(n.find('select[data-role="entry"]').val()??NaN);t.push({worldbookName:o,entryUid:r}),n.find('[data-worldbook-row-id]').each(function(){const n=$(this),e=String(n.find('select[data-role="worldbook-extra"]').val()??''),a=Number(n.find('select[data-role="entry-extra"]').val()??NaN);t.push({worldbookName:e,entryUid:a})});const l=String(n.find('select[data-role="regex"]').val()??'');a.push(l),n.find('[data-regex-row-id]').each(function(){const n=$(this),e=String(n.find('select[data-role="regex-extra"]').val()??'');a.push(e)});const s=t.filter(n=>n.worldbookName&&Number.isInteger(n.entryUid)),c=a.filter(n=>n.length>0);if(0===s.length||0===c.length)return void toastr.warning('请至少完整选择一条世界书条目，并至少选择一条正则');const p=d();let f=0;for(const n of s){const t=(await getWorldbook(n.worldbookName)).find(e=>e.uid===n.entryUid);if(t)for(const a of c){const o=p.find(n=>n.id===a);o&&(e.bindings.find(e=>e.worldbook_name===n.worldbookName&&e.worldbook_entry_uid===n.entryUid&&e.regex_id===a)||(e.bindings.push({id:SillyTavern.uuidv4(),label:`${n.worldbookName} / ${t.name||t.uid}`,worldbook_name:n.worldbookName,worldbook_entry_uid:t.uid,worldbook_entry_name:t.name||`未命名条目-${t.uid}`,regex_id:o.id,regex_script_name:o.script_name}),f+=1))}}0!==f?(await i(e),toastr.success(`已创建 ${f} 条绑定`)):toastr.info('没有新增绑定（可能已存在或选择无效）')}(e,n),await v(e,n)}),e.on('click','[data-action="toggleBinding"]',async function(){const t=String($(this).data('id')??''),a=n.bindings.find(n=>n.id===t);if(!a)return;const o=await c(a),i=!(!0===o.worldbook_enabled&&!0===o.regex_enabled);try{await async function(n,e){let t=!1,a=!1;if(await updateWorldbookWith(n.worldbook_name,a=>a.map(a=>a.uid===n.worldbook_entry_uid?(t=!0,{...a,enabled:e}):a)),await updateTavernRegexesWith(t=>t.map(t=>t.id===n.regex_id?(a=!0,{...t,enabled:e,script_name:r(t.script_name)}):t)),!t&&!a)throw new Error('未找到可切换的世界书条目或正则')}(a,i),toastr.success(`${a.label} 已${i?'开启':'关闭'}`)}catch(n){console.error(n),toastr.error('同步开关失败')}await v(e,n)}),e.on('click','[data-action="deleteBinding"]',async function(){const t=String($(this).data('id')??'');n.bindings=n.bindings.filter(n=>n.id!==t),await i(n),await v(e,n),toastr.success('绑定已删除')}),e.on('click','[data-action="renameStyle"]',async function(){const t=String($(this).data('id')??''),a=n.bindings.find(n=>n.id===t);if(!a)return;const o=await async function(n,e=''){const t=await SillyTavern.callGenericPopup(n,SillyTavern.POPUP_TYPE.INPUT,e,{okButton:'确认',cancelButton:'取消',rows:3,wider:!0});return!1===t||null==t?null:String(t).trim()}('输入新的显示名',a.label);o&&(a.label=o,await i(n),await v(e,n),toastr.success('名称已更新'))}),e.on('click','[data-action="previewStyle"]',async function(){const e=String($(this).data('id')??''),t=n.bindings.find(n=>n.id===e);t&&await g(t)}),e.on('click','[data-action="refresh"]',async()=>{await v(e,n),toastr.info('已刷新')}),e.on('keydown','[role="button"][data-action]',function(n){'Enter'!==n.key&&' '!==n.key||(n.preventDefault(),$(this).trigger('click'))}),e.on('touchend','[role="button"][data-action]',function(n){n.preventDefault(),n.stopPropagation(),$(this).trigger('click')}),await v(e,n),p(e,'style'),await function(n){return new Promise(e=>{const t=$('\n      <div\n        data-role="statusbar-manager-overlay"\n        style="position:fixed; inset:0; z-index:2147482600; background:rgba(0,0,0,.72); display:flex;"\n      >\n        <style>\n          [data-role="statusbar-manager-overlay"] [data-role="managerScroll"] {\n            scrollbar-width: none;\n            -ms-overflow-style: none;\n          }\n          [data-role="statusbar-manager-overlay"] [data-role="managerScroll"]::-webkit-scrollbar {\n            width: 0;\n            height: 0;\n            display: none;\n          }\n        </style>\n        <div style="position:absolute; inset:0; display:flex; flex-direction:column; background:var(--SmartThemeBlurTintColor, #111); color:var(--SmartThemeBodyColor, #f3f3f3); box-shadow:none; border:none;">\n          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; border-bottom:1px solid rgba(127,127,127,.35); flex:0 0 auto; background:var(--SmartThemeBlurTintColor, #111);">\n            <div style="font-weight:600;">状态栏管理</div>\n            <button type="button" data-role="closeManager" style="padding:6px 12px; border:none; border-radius:6px; cursor:pointer;">关闭</button>\n          </div>\n          <div data-role="managerScroll" style="flex:1; min-height:0; overflow:auto; -webkit-overflow-scrolling:touch;"></div>\n        </div>\n      </div>\n    ');t.find('[data-role="managerScroll"]').append(n);const a=()=>{$(document).off('keydown',o),t.remove(),e()},o=n=>{'Escape'===n.key&&a()};t.on('click','[data-role="closeManager"]',()=>{a()}),$(document).on('keydown',o),$('body').append(t)})}(e)}function y(){if($(`#${e}`).length>0)return;const t=function(){const n=['#extensionsMenu','#extensions-menu','#extensions_dropdown','#extensions_settings2','.extensionsMenu','.extensions-menu','.drawer-content:has(.fa-solid), .drawer-content:has(.fa-regular)'];for(const e of n){const n=$(e).first();if(n.length>0)return n}return $()}();0!==t.length&&t.append($(`<div id="${e}" role="button" tabindex="0"><i class="fa-solid fa-puzzle-piece"></i> ${n}</div>`).on('click',async()=>{await eventEmit(getButtonEvent(n))}).on('keydown',async e=>{'Enter'!==e.key&&' '!==e.key||(e.preventDefault(),await eventEmit(getButtonEvent(n)))}))}$(()=>{replaceScriptButtons([]),eventOn(getButtonEvent(n),async()=>{try{await w()}catch(n){console.error(n),toastr.error('状态栏管理器打开失败')}}),y(),eventOn(tavern_events.APP_READY,y),eventOn(tavern_events.EXTENSIONS_FIRST_LOAD,y);const t=new MutationObserver(()=>{y()});t.observe(document.body,{childList:!0,subtree:!0}),$(window).on('pagehide',()=>{t.disconnect(),$(`#${e}`).remove()})});