const t='状态栏管理',n='th-status-bar-extension-entry',e='status_bar_manager_script',a='[状态栏] ';function i(){return SillyTavern.extensionSettings[e]||(SillyTavern.extensionSettings[e]={bindings:[]}),SillyTavern.extensionSettings[e]}async function o(t){i().bindings=t.bindings,await SillyTavern.saveSettingsDebounced()}function r(t){return t.startsWith(a)?t:`${a}${t}`}function d(){return getTavernRegexes().filter(t=>t.script_name.startsWith(a))}function l(t){return getTavernRegexes().find(n=>n.id===t)}async function s(t){const n=t.find('input[data-role="regexFile"]')[0];if(!n?.files?.length)return;const e=n.files[0];let a='';try{a=await e.text()}catch{return void toastr.error('读取文件失败')}const i=new Set(getTavernRegexes().map(t=>t.id));let o=[];try{const t=JSON.parse(a),n=(l=t,Array.isArray(l)?l:Array.isArray(l?.regex_scripts)?l.regex_scripts:Array.isArray(l?.data?.regex_scripts)?l.data.regex_scripts:l&&'object'==typeof l?[l]:[]);o=n.map(t=>function(t){return String(t.script_name??t.scriptName??t.name??t.title??'').trim()}(t)).filter(t=>t.length>0)}catch{o=[]}var l;if(!importRawTavernRegex(e.name,a))return void toastr.error('导入失败，请确认使用酒馆原生正则导出文件');await updateTavernRegexesWith(t=>{let n=0;return t.map(t=>{if(!!i.has(t.id))return t;const e=o[n]??t.script_name;return n+=1,{...t,script_name:r(e)}})});const s=d().length;toastr.success(`已导入，当前可管理状态栏正则 ${s} 条`)}async function c(t){let n=null,e=null;try{const e=(await getWorldbook(t.worldbook_name)).find(n=>n.uid===t.worldbook_entry_uid);e&&(n=e.enabled)}catch{}const a=l(t.regex_id);return a&&(e=a.enabled),{worldbook_enabled:n,regex_enabled:e}}function p(t,n){const e=t.find('[data-role="tab-binding"]'),a=t.find('[data-role="tab-style"]');'binding'===n?(e.show(),a.hide()):(e.hide(),a.show())}async function f(t){const n=getWorldbookNames(),e=t=>{if(t.empty(),0!==n.length)for(const e of n)t.append(`<option value="${e}">${e}</option>`);else t.append('<option value="">（无世界书）</option>')};e(t.find('select[data-role="worldbook"]')),t.find('select[data-role="worldbook-extra"]').each(function(){e($(this))})}async function u(t){const n=async(t,n)=>{if(t.empty(),!n)return void t.append('<option value="">（先选择世界书）</option>');const e=await getWorldbook(n);if(0!==e.length)for(const n of e){const e=n.name||`未命名条目-${n.uid}`;t.append(`<option value="${n.uid}">${e} (uid=${n.uid})</option>`)}else t.append('<option value="">（该世界书无条目）</option>')},e=String(t.find('select[data-role="worldbook"]').val()??'');await n(t.find('select[data-role="entry"]'),e);const a=t.find('select[data-role="worldbook-extra"]');for(let t=0;t<a.length;t+=1){const e=$(a[t]),i=e.closest('[data-worldbook-row-id]'),o=String(e.val()??''),r=i.find('select[data-role="entry-extra"]');await n(r,o)}}function b(t){const n=d(),e=t=>{if(t.empty(),0!==n.length)for(const e of n)t.append(`<option value="${e.id}">${e.script_name}</option>`);else t.append('<option value="">（暂无状态栏正则，请先导入）</option>')};e(t.find('select[data-role="regex"]')),t.find('select[data-role="regex-extra"]').each(function(){e($(this))})}async function g(t,n){await f(t),await u(t),b(t),await async function(t,n){const e=t.find('[data-role="styleList"]');if(e.empty(),0===n.bindings.length)return void e.append('<div>暂无样式</div>');const a=$('<table><thead><tr><th>显示名</th><th>世界书</th><th>条目</th><th>正则名</th><th>同步开关</th><th>操作</th></tr></thead><tbody></tbody></table>'),i=a.find('tbody');for(const t of n.bindings){const n=await c(t),e=!0===n.worldbook_enabled&&!0===n.regex_enabled,a=$(`<tr>\n        <td>${t.label}</td>\n        <td>${t.worldbook_name}</td>\n        <td>${t.worldbook_entry_name} (uid=${t.worldbook_entry_uid})</td>\n        <td>${t.regex_script_name}</td>\n        <td><span role="button" tabindex="0" data-action="toggleBinding" data-id="${t.id}"><i class="fa-solid fa-power-off"></i> ${e?'关闭':'开启'}</span></td>\n        <td>\n          <span role="button" tabindex="0" data-action="renameStyle" data-id="${t.id}"><i class="fa-solid fa-pen"></i> 改名</span>\n          <span role="button" tabindex="0" data-action="previewStyle" data-id="${t.id}"><i class="fa-solid fa-eye"></i> 预览</span>\n          <span role="button" tabindex="0" data-action="deleteBinding" data-id="${t.id}"><i class="fa-solid fa-trash"></i> 删除</span>\n        </td>\n      </tr>`);i.append(a)}e.append(a)}(t,n)}async function w(){const t=function(){const t=i();return Array.isArray(t.bindings)||(t.bindings=[]),{bindings:t.bindings}}(),n=$('\n    <div>\n      <h3><i class="fa-solid fa-puzzle-piece"></i> 状态栏管理器</h3>\n\n      <div style="display:flex; gap:14px; align-items:center; flex-wrap:wrap; margin:8px 0 12px;">\n        <span role="button" tabindex="0" data-action="switchTab" data-tab="binding"><i class="fa-solid fa-link"></i> 绑定状态栏</span>\n        <span role="button" tabindex="0" data-action="switchTab" data-tab="style"><i class="fa-solid fa-list"></i> 状态栏样式列表</span>\n      </div>\n\n      <div data-role="tab-binding">\n        <h4>绑定状态栏</h4>\n        <div>\n          <label>世界书：</label>\n          <select data-role="worldbook"></select>\n        </div>\n        <div>\n          <label>世界书条目：</label>\n          <select data-role="entry"></select>\n        </div>\n        <div>\n          <span role="button" tabindex="0" data-action="addWorldbookRow"><i class="fa-solid fa-plus"></i> 增加世界书条目</span>\n        </div>\n        <div data-role="extraWorldbookRows"></div>\n        <div style="margin-top:8px;">\n          <label>状态栏正则：</label>\n          <select data-role="regex"></select>\n        </div>\n        <div>\n          <span role="button" tabindex="0" data-action="addRegexRow"><i class="fa-solid fa-plus"></i> 增加正则</span>\n        </div>\n        <div data-role="extraRegexRows"></div>\n        <div style="display:flex; gap:14px; align-items:center; flex-wrap:wrap; margin-top:8px;">\n          <span role="button" tabindex="0" data-action="pickRegexFile"><i class="fa-solid fa-file-import"></i> 导入正则文件</span>\n          <span role="button" tabindex="0" data-action="createBinding"><i class="fa-solid fa-plus"></i> 创建绑定</span>\n          <span role="button" tabindex="0" data-action="refresh"><i class="fa-solid fa-rotate"></i> 刷新</span>\n        </div>\n        <input type="file" data-role="regexFile" accept=".json,application/json" style="display:none;" />\n\n      </div>\n\n      <div data-role="tab-style" style="display:none;">\n        <h4>状态栏样式列表</h4>\n        <div data-role="styleList"></div>\n      </div>\n    </div>\n  ');n.on('change','select[data-role="worldbook"]',async()=>{await u(n)}),n.on('change','select[data-role="worldbook-extra"]',async()=>{await u(n)}),n.on('click','[data-action="switchTab"]',function(){const t=String($(this).data('tab')??'binding');p(n,'style'===t?'style':'binding')}),n.on('click','[data-action="pickRegexFile"]',()=>{const t=n.find('input[data-role="regexFile"]');t.val(''),t.trigger('click')}),n.on('change','input[data-role="regexFile"]',async()=>{await s(n),await g(n,t)}),n.on('click','[data-action="addWorldbookRow"]',async()=>{n.find('[data-role="extraWorldbookRows"]').append($(`<div data-worldbook-row-id="${SillyTavern.uuidv4()}" style="margin-top:8px;">\n      <div>\n        <label>世界书：</label>\n        <select data-role="worldbook-extra"></select>\n      </div>\n      <div>\n        <label>世界书条目：</label>\n        <select data-role="entry-extra"></select>\n      </div>\n      <div>\n        <span role="button" tabindex="0" data-action="removeWorldbookRow"><i class="fa-solid fa-trash"></i> 删除此世界书条目</span>\n      </div>\n    </div>`)),await f(n),await u(n)}),n.on('click','[data-action="removeWorldbookRow"]',async function(){$(this).closest('[data-worldbook-row-id]').remove()}),n.on('click','[data-action="addRegexRow"]',async()=>{n.find('[data-role="extraRegexRows"]').append($(`<div data-regex-row-id="${SillyTavern.uuidv4()}" style="margin-top:8px;">\n      <div>\n        <label>状态栏正则：</label>\n        <select data-role="regex-extra"></select>\n      </div>\n      <div>\n        <span role="button" tabindex="0" data-action="removeRegexRow"><i class="fa-solid fa-trash"></i> 删除此正则</span>\n      </div>\n    </div>`)),b(n)}),n.on('click','[data-action="removeRegexRow"]',async function(){$(this).closest('[data-regex-row-id]').remove()}),n.on('click','[data-action="createBinding"]',async()=>{await async function(t,n){const e=[],a=[],i=String(t.find('select[data-role="worldbook"]').val()??''),r=Number(t.find('select[data-role="entry"]').val()??NaN);e.push({worldbookName:i,entryUid:r}),t.find('[data-worldbook-row-id]').each(function(){const t=$(this),n=String(t.find('select[data-role="worldbook-extra"]').val()??''),a=Number(t.find('select[data-role="entry-extra"]').val()??NaN);e.push({worldbookName:n,entryUid:a})});const l=String(t.find('select[data-role="regex"]').val()??'');a.push(l),t.find('[data-regex-row-id]').each(function(){const t=$(this),n=String(t.find('select[data-role="regex-extra"]').val()??'');a.push(n)});const s=e.filter(t=>t.worldbookName&&Number.isInteger(t.entryUid)),c=a.filter(t=>t.length>0);if(0===s.length||0===c.length)return void toastr.warning('请至少完整选择一条世界书条目，并至少选择一条正则');const p=d();let f=0;for(const t of s){const e=(await getWorldbook(t.worldbookName)).find(n=>n.uid===t.entryUid);if(e)for(const a of c){const i=p.find(t=>t.id===a);i&&(n.bindings.find(n=>n.worldbook_name===t.worldbookName&&n.worldbook_entry_uid===t.entryUid&&n.regex_id===a)||(n.bindings.push({id:SillyTavern.uuidv4(),label:`${t.worldbookName} / ${e.name||e.uid}`,worldbook_name:t.worldbookName,worldbook_entry_uid:e.uid,worldbook_entry_name:e.name||`未命名条目-${e.uid}`,regex_id:i.id,regex_script_name:i.script_name}),f+=1))}}0!==f?(await o(n),toastr.success(`已创建 ${f} 条绑定`)):toastr.info('没有新增绑定（可能已存在或选择无效）')}(n,t),await g(n,t)}),n.on('click','[data-action="toggleBinding"]',async function(){const e=String($(this).data('id')??''),a=t.bindings.find(t=>t.id===e);if(!a)return;const i=await c(a),o=!(!0===i.worldbook_enabled&&!0===i.regex_enabled);try{await async function(t,n){let e=!1,a=!1;if(await updateWorldbookWith(t.worldbook_name,a=>a.map(a=>a.uid===t.worldbook_entry_uid?(e=!0,{...a,enabled:n}):a)),await updateTavernRegexesWith(e=>e.map(e=>e.id===t.regex_id?(a=!0,{...e,enabled:n,script_name:r(e.script_name)}):e)),!e&&!a)throw new Error('未找到可切换的世界书条目或正则')}(a,o),toastr.success(`${a.label} 已${o?'开启':'关闭'}`)}catch(t){console.error(t),toastr.error('同步开关失败')}await g(n,t)}),n.on('click','[data-action="deleteBinding"]',async function(){const e=String($(this).data('id')??'');t.bindings=t.bindings.filter(t=>t.id!==e),await o(t),await g(n,t),toastr.success('绑定已删除')}),n.on('click','[data-action="renameStyle"]',async function(){const e=String($(this).data('id')??''),a=t.bindings.find(t=>t.id===e);if(!a)return;const i=await async function(t,n=''){const e=await SillyTavern.callGenericPopup(t,SillyTavern.POPUP_TYPE.INPUT,n,{okButton:'确认',cancelButton:'取消',rows:3,wider:!0});return!1===e||null==e?null:String(e).trim()}('输入新的显示名',a.label);i&&(a.label=i,await o(t),await g(n,t),toastr.success('名称已更新'))}),n.on('click','[data-action="previewStyle"]',async function(){const n=String($(this).data('id')??''),e=t.bindings.find(t=>t.id===n);e&&await async function(t){const n=l(t.regex_id);if(!n)return void toastr.error('未找到对应正则');const e=$(`<div>\n      <h4>${t.label}</h4>\n      <div data-role="previewBox"></div>\n    </div>`),a=e.find('[data-role="previewBox"]'),i=function(t){const n=t.trim(),e=n.match(/^```[a-zA-Z0-9_-]*\n([\s\S]*?)\n```$/);return e?e[1].trim():n}(String(n.replace_string??''));0===i.length?a.text('该正则 replace_string 为空，暂无可预览内容。'):a.html(i),await SillyTavern.callGenericPopup(e,SillyTavern.POPUP_TYPE.DISPLAY,'',{okButton:'关闭',leftAlign:!0})}(e)}),n.on('click','[data-action="refresh"]',async()=>{await g(n,t),toastr.info('已刷新')}),n.on('keydown','[role="button"][data-action]',function(t){'Enter'!==t.key&&' '!==t.key||(t.preventDefault(),$(this).trigger('click'))}),await g(n,t),p(n,'style'),await SillyTavern.callGenericPopup(n,SillyTavern.POPUP_TYPE.DISPLAY,'',{okButton:'关闭',wide:!0,wider:!0,large:!0,leftAlign:!0})}function v(){if($(`#${n}`).length>0)return;const e=function(){const t=['#extensionsMenu','#extensions-menu','#extensions_dropdown','#extensions_settings2','.extensionsMenu','.extensions-menu','.drawer-content:has(.fa-solid), .drawer-content:has(.fa-regular)'];for(const n of t){const t=$(n).first();if(t.length>0)return t}return $()}();0!==e.length&&e.append($(`<div id="${n}" role="button" tabindex="0"><i class="fa-solid fa-puzzle-piece"></i> ${t}</div>`).on('click',async()=>{await eventEmit(getButtonEvent(t))}).on('keydown',async n=>{'Enter'!==n.key&&' '!==n.key||(n.preventDefault(),await eventEmit(getButtonEvent(t)))}))}$(()=>{replaceScriptButtons([]),eventOn(getButtonEvent(t),async()=>{try{await w()}catch(t){console.error(t),toastr.error('状态栏管理器打开失败')}}),v(),eventOn(tavern_events.APP_READY,v),eventOn(tavern_events.EXTENSIONS_FIRST_LOAD,v);const e=new MutationObserver(()=>{v()});e.observe(document.body,{childList:!0,subtree:!0}),$(window).on('pagehide',()=>{e.disconnect(),$(`#${n}`).remove()})});